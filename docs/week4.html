<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; Week 4 – Intro to SQL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./miscellaneous.html" rel="next">
<link href="./week1.html" rel="prev">
<link href="./img/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link rel="stylesheet" href="style.css">
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week4.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Week 4</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="https://hutchdatascience.org/" class="sidebar-logo-link">
      <img src="./img/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Intro to SQL</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/fhdsl/intro_to_sql" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro to SQL</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./concepts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Database Concepts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Week 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week4.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Week 4</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./miscellaneous.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Miscellaneous Grabbag</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#connecting-to-our-database" id="toc-connecting-to-our-database" class="nav-link active" data-scroll-target="#connecting-to-our-database"><span class="header-section-number">3.1</span> Connecting to our database</a></li>
  <li>
<a href="#subqueries" id="toc-subqueries" class="nav-link" data-scroll-target="#subqueries"><span class="header-section-number">3.2</span> Subqueries</a>
  <ul class="collapse">
<li><a href="#using-a-subquery-in-the-select-clause" id="toc-using-a-subquery-in-the-select-clause" class="nav-link" data-scroll-target="#using-a-subquery-in-the-select-clause"><span class="header-section-number">3.2.1</span> Using a Subquery in the <code>SELECT</code> Clause</a></li>
  <li><a href="#example-using-a-subquery-in-the-select-clause" id="toc-example-using-a-subquery-in-the-select-clause" class="nav-link" data-scroll-target="#example-using-a-subquery-in-the-select-clause"><span class="header-section-number">3.2.2</span> Example: Using a Subquery in the <code>SELECT</code> Clause</a></li>
  <li><a href="#filtering-with-a-subquery" id="toc-filtering-with-a-subquery" class="nav-link" data-scroll-target="#filtering-with-a-subquery"><span class="header-section-number">3.2.3</span> Filtering with a Subquery</a></li>
  <li><a href="#example-filtering-with-a-subquery" id="toc-example-filtering-with-a-subquery" class="nav-link" data-scroll-target="#example-filtering-with-a-subquery"><span class="header-section-number">3.2.4</span> Example: Filtering with a Subquery</a></li>
  <li><a href="#when-to-use-subqueries" id="toc-when-to-use-subqueries" class="nav-link" data-scroll-target="#when-to-use-subqueries"><span class="header-section-number">3.2.5</span> When to use subqueries</a></li>
  </ul>
</li>
  <li>
<a href="#views" id="toc-views" class="nav-link" data-scroll-target="#views"><span class="header-section-number">3.3</span> Views</a>
  <ul class="collapse">
<li><a href="#when-to-use-views" id="toc-when-to-use-views" class="nav-link" data-scroll-target="#when-to-use-views"><span class="header-section-number">3.3.1</span> When to use views</a></li>
  <li><a href="#a-brief-tangent-indexing" id="toc-a-brief-tangent-indexing" class="nav-link" data-scroll-target="#a-brief-tangent-indexing"><span class="header-section-number">3.3.2</span> A brief tangent: indexing</a></li>
  <li><a href="#example-creating-a-view" id="toc-example-creating-a-view" class="nav-link" data-scroll-target="#example-creating-a-view"><span class="header-section-number">3.3.3</span> Example: Creating a View</a></li>
  </ul>
</li>
  <li><a href="#query-optimization" id="toc-query-optimization" class="nav-link" data-scroll-target="#query-optimization"><span class="header-section-number">3.4</span> Query Optimization</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">3.5</span> Summary</a></li>
  <li><a href="#always-close-the-connection" id="toc-always-close-the-connection" class="nav-link" data-scroll-target="#always-close-the-connection"><span class="header-section-number">3.6</span> Always close the connection</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">3.7</span> References</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/fhdsl/intro_to_sql/edit/main/week4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Week 4</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>In this lecture, we will explore <strong>subqueries</strong> and <strong>views</strong> in SQL. These concepts help us break complicated queries into smaller, more manageable parts, improving our ability to read and maintain our code.</p>
<section id="connecting-to-our-database" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="connecting-to-our-database">
<span class="header-section-number">3.1</span> Connecting to our database</h2>
<p>As always, to access the data, we create our database connection to our Synthea breast cancer data.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r.duckdb.org/">duckdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html">duckdb</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>  <span class="st">"data/GiBleed_5.3_1.1.duckdb"</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With our data loaded and ready to go, let’s get started!</p>
</section><section id="subqueries" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="subqueries">
<span class="header-section-number">3.2</span> Subqueries</h2>
<p>A subquery is a query nested inside another query. Subqueries let us process smaller computations inside larger outer queries.</p>
<section id="using-a-subquery-in-the-select-clause" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="using-a-subquery-in-the-select-clause">
<span class="header-section-number">3.2.1</span> Using a Subquery in the <code>SELECT</code> Clause</h3>
<p>The following is a great example from <a href="https://dataschool.com/how-to-teach-people-sql/how-sql-subqueries-work/">The Data School</a>, offering a visualization of how a subquery works. In this case, we use a subquery to calculate the total number of friends across all individuals, subdivided by state. Here, we are making use of the subquery within our <code>SELECT</code> clause. Let’s dive a little deeper into this type of example using our own data.</p>
<p><img src="https://dataschool.com/assets/images/how-to-teach-people-sql/subqueries/subqueries_1.gif" class="img-fluid"></p>
<section id="a-brief-tangent-using-datediff-to-compare-dates" class="level4" data-number="3.2.1.1"><h4 data-number="3.2.1.1" class="anchored" data-anchor-id="a-brief-tangent-using-datediff-to-compare-dates">
<span class="header-section-number">3.2.1.1</span> A brief tangent: using <code>DATEDIFF</code> to compare dates</h4>
<p>The <code>DATEDIFF</code> function in SQL can be used to calculate differences between days. <code>DATEDIFF</code> takes three parameters: the unit of time, a first date, and a second date. For instance, calling:</p>
<pre><code>SELECT DATEDIFF('month', DATE '2020-01-01', DATE '2024-03-07')</code></pre>
<p>calculates the number of months between January 1st, 2020, and March 7th, 2024. All three parameters are required. You can refer to the documentation for <code>DATEDIFF</code> <a href="https://www.w3schools.com/sql/func_sqlserver_datediff.asp">here</a> to see other options for time intervals.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Dates in SQL typically follow the ISO 8601 format of ‘YYYY-MM-DD’. Other date formats may work depending on the database system being used, though there is a chance for misinterpretation.</p>
<p>Note that in our example, we explicitly cast our two dates as <code>DATE</code> variables - while this is not necessary depending on the database system, it enhances readability and interpretability of the code for both other users as well as the database system.</p>
</div>
</div>
<ol type="1">
<li><strong>What do you think happens if we swap the order of dates in the <code>DATEDIFF</code> command?</strong></li>
</ol></section></section><section id="example-using-a-subquery-in-the-select-clause" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="example-using-a-subquery-in-the-select-clause">
<span class="header-section-number">3.2.2</span> Example: Using a Subquery in the <code>SELECT</code> Clause</h3>
<p>Let’s use a subquery to dynamically calculate the age of each individual (as of March 7th, 2024) in our database while collecting other patient demographic data. To handle this, we’ll make use of the <code>person</code> table in our dataframe and the <code>birth_datetime</code> column.</p>
<div class="cell" data-output.var="person_age">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  person_id, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  birth_datetime,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  gender_source_value, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  race_source_value, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  ethnicity_source_value,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">SELECT</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    DATE_DIFF(<span class="st">'year'</span>, birth_datetime, <span class="dt">DATE</span> <span class="st">'2024-03-07'</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">AS</span> age</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  person;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see in the above example, we’ve performed the computation of calculating patient age in a subquery:</p>
<pre><code>SELECT 
    DATE_DIFF('year', birth_datetime, DATE '2024-03-07')</code></pre>
<p>This subquery is integrated into the larger query of collecting patient data.</p>
<section id="check-on-learning" class="level4" data-number="3.2.2.1"><h4 data-number="3.2.2.1" class="anchored" data-anchor-id="check-on-learning">
<span class="header-section-number">3.2.2.1</span> Check on learning</h4>
<p>Fill in the blank in the query below to dynamically calculate the <strong>number of days</strong> between the <strong>condition start date</strong> and <strong>condition end date</strong> for all conditions from the <code>condition_occurrence</code> table</p>
<div class="cell" data-output.var="condition_time">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  person_id,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  visit_occurrence_id,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  condition_occurrence_id,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  condition_concept_id, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  condition_start_date,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  condition_end_date,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  (_____________________) <span class="kw">AS</span> condition_time_span</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  condition_occurrence;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="filtering-with-a-subquery" class="level3" data-number="3.2.3"><h3 data-number="3.2.3" class="anchored" data-anchor-id="filtering-with-a-subquery">
<span class="header-section-number">3.2.3</span> Filtering with a Subquery</h3>
<p>We’ve now worked through a couple of examples where we use subqueries to create new variables within our <code>SELECT</code> clause. Another type of query we can tackle is the filtration of data based on conditions calculated in a subquery.</p>
<p>Here’s another great example from <a href="https://dataschool.com/how-to-teach-people-sql/how-sql-subqueries-work/">The Data School</a>, where we apply a subquery in the filtration component of our larger query to find individuals on Facebook who have the same number of Facebook connections as anyone else on LinkedIn.</p>
<p><img src="https://dataschool.com/assets/images/how-to-teach-people-sql/subqueries/subqueries_7.gif" class="img-fluid"></p>
<section id="a-brief-tangent-the-in-clause" class="level4" data-number="3.2.3.1"><h4 data-number="3.2.3.1" class="anchored" data-anchor-id="a-brief-tangent-the-in-clause">
<span class="header-section-number">3.2.3.1</span> A brief tangent: the <code>IN</code> clause</h4>
<p>The <code>IN</code> clause in SQL is used to filter records where a column matches any value in a specified list or subquery result. It is a shorthand for multiple <code>OR</code> conditions and is commonly used for readability and efficiency.</p>
<p>For instance, the basic syntax of:</p>
<pre><code>SELECT column_name
FROM table_name
WHERE column_name IN (value1, value2, value3);</code></pre>
<p>is equivalent to:</p>
<pre><code>SELECT column_name
FROM table_name
WHERE column_name = value1 
   OR column_name = value2 
   OR column_name = value3;</code></pre>
<p>Now back to using a subquery for filtering!</p>
</section></section><section id="example-filtering-with-a-subquery" class="level3" data-number="3.2.4"><h3 data-number="3.2.4" class="anchored" data-anchor-id="example-filtering-with-a-subquery">
<span class="header-section-number">3.2.4</span> Example: Filtering with a Subquery</h3>
<p>For our own database, let’s collect patient demographic data for all patients who had some kind of procedure performed after January 1st, 2019. We’ll make use of the <code>person</code> and <code>procedure_occurrence</code> tables for this query.</p>
<div class="cell" data-output.var="recent_pts">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  person_id, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  birth_datetime, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  gender_source_value, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  race_source_value, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  ethnicity_source_value</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  person</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  person_id <span class="kw">IN</span> (</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">SELECT</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      person_id </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      procedure_occurrence</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WHERE</span> </span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      procedure_datetime <span class="op">&gt;=</span> <span class="dt">DATE</span> <span class="st">'2019-01-01'</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  );</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="check-on-learning-1" class="level4" data-number="3.2.4.1"><h4 data-number="3.2.4.1" class="anchored" data-anchor-id="check-on-learning-1">
<span class="header-section-number">3.2.4.1</span> Check on learning</h4>
<p>Fill in the blank in the following SQL query to select relevant patient data for any patient in the <code>condition_occurrence</code> table who had a <strong>condition start date</strong> on or after January 1st, 2019.</p>
<div class="cell" data-output.var="recent_pts">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  person_id, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  birth_datetime, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  gender_source_value, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  race_source_value, </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  ethnicity_source_value</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  person</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  person_id <span class="kw">IN</span> (_________);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="when-to-use-subqueries" class="level3" data-number="3.2.5"><h3 data-number="3.2.5" class="anchored" data-anchor-id="when-to-use-subqueries">
<span class="header-section-number">3.2.5</span> When to use subqueries</h3>
<p>Subqueries are powerful because they allow you to break down complex queries into smaller, more manageable parts. You should use subqueries when:</p>
<ul>
<li><p><strong>You need to use a computed value in a query</strong>: See our previous examples!</p></li>
<li><p><strong>You want to avoid duplicating code</strong>: Instead of repeating a calculation, you can use a subquery to define it a single time and reuse it (i.e.&nbsp;<code>age</code>).</p></li>
<li><p><strong>You want to avoid performing unnecessary <code>JOIN</code>’s</strong>: Subqueries let you filter results row-by-row based on information from another table without requiring a <code>JOIN</code>.</p></li>
<li><p><strong>You need to improve your code’s readability</strong>: Subqueries help make queries more modular and easier to debug. Conceptually, it can be easier to create a multi-step query and check intermediate phases than do perform a bunch of <code>JOIN</code>’s.</p></li>
</ul>
<ol start="2" type="1">
<li><strong>Can you think of any examples where it might be better to use a <code>JOIN</code> over a subquery?</strong></li>
</ol></section></section><section id="views" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="views">
<span class="header-section-number">3.3</span> Views</h2>
<p>A <em>view</em> is a stored SQL query that acts as a virtual table. Views improve code reuse and readability. The following image, taken from <a href="https://www.sqlshack.com/create-view-sql-modifying-views-in-sql-server/">SQLShack</a>, depicts how a complicated query can be turned into a customized view that can be used in downstream data processing.</p>
<p><img src="https://www.sqlshack.com/wp-content/uploads/2020/03/an-executed-create-view-sql-script-showing-data-re.png" class="img-fluid"></p>
<section id="when-to-use-views" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="when-to-use-views">
<span class="header-section-number">3.3.1</span> When to use views</h3>
<p>Similar to subqueries, views allow us to organize our data into more modular, accessible, and easy-to-read components. You should use views when:</p>
<ul>
<li><p><strong>You want to simplify complex queries and improve code maintainability</strong>: Instead of frequently reusing a complex query, you can store the data generated from the query into a view and access it readily.</p></li>
<li><p><strong>You want to enhance security and restrict data access to others without authorization</strong>: Making your own view can limit access to sensitive columns while still allowing other users to query the necessary data</p></li>
<li><p><strong>You want to promote data consistency</strong>: Performing a calculation in a view ensures that everyone uses the same calculation to grab consistent data (e.g.&nbsp;calculating age of patients)</p></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A view itself does not actually store data like a physical table does. Instead, a view is a saved SQL query that gets executed each time you query the view.</p>
</div>
</div>
</section><section id="a-brief-tangent-indexing" class="level3" data-number="3.3.2"><h3 data-number="3.3.2" class="anchored" data-anchor-id="a-brief-tangent-indexing">
<span class="header-section-number">3.3.2</span> A brief tangent: indexing</h3>
<p><strong>Indexing</strong> is a technique used to speed up data retrieval from a database table. An index improves the efficiency of queries by allowing the database to locate rows faster without having to scan the entire table. This is similar to how a table of contents in a book helps you quickly find chapters instead of reading every page.</p>
<p>However, <strong>views are not indexed</strong>: Since views are virtual tables, they do not store data or have their own indexes. Instead, they rely on the indexes that come from the underlying tables. Because views do not have indexes, <strong>querying a view can be slower than querying a physical table</strong>. Indeed, since the database recomputes the view’s query each time, more complex views can lead to performance issues.</p>
</section><section id="example-creating-a-view" class="level3" data-number="3.3.3"><h3 data-number="3.3.3" class="anchored" data-anchor-id="example-creating-a-view">
<span class="header-section-number">3.3.3</span> Example: Creating a View</h3>
<p>With our own data, let’s create a view from the <code>concept</code> table that focuses on the drugs in our dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> drugs <span class="kw">AS</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> concept</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> domain_id <span class="op">==</span> <span class="st">'Drug'</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can use this view just like a table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> drugs</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>5 records</caption>
<colgroup>
<col style="width: 6%">
<col style="width: 26%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 7%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
</colgroup>
<thead><tr class="header">
<th style="text-align: right;">concept_id</th>
<th style="text-align: left;">concept_name</th>
<th style="text-align: left;">domain_id</th>
<th style="text-align: left;">vocabulary_id</th>
<th style="text-align: left;">concept_class_id</th>
<th style="text-align: left;">standard_concept</th>
<th style="text-align: left;">concept_code</th>
<th style="text-align: left;">valid_start_date</th>
<th style="text-align: left;">valid_end_date</th>
<th style="text-align: left;">invalid_reason</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1118088</td>
<td style="text-align: left;">celecoxib 200 MG Oral Capsule [Celebrex]</td>
<td style="text-align: left;">Drug</td>
<td style="text-align: left;">RxNorm</td>
<td style="text-align: left;">Branded Drug</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">213469</td>
<td style="text-align: left;">1970-01-01</td>
<td style="text-align: left;">2099-12-31</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">40213201</td>
<td style="text-align: left;">pneumococcal polysaccharide vaccine, 23 valent</td>
<td style="text-align: left;">Drug</td>
<td style="text-align: left;">CVX</td>
<td style="text-align: left;">CVX</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">33</td>
<td style="text-align: left;">2008-12-01</td>
<td style="text-align: left;">2099-12-31</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1557272</td>
<td style="text-align: left;">Alendronate</td>
<td style="text-align: left;">Drug</td>
<td style="text-align: left;">RxNorm</td>
<td style="text-align: left;">Ingredient</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">46041</td>
<td style="text-align: left;">1970-01-01</td>
<td style="text-align: left;">2099-12-31</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">19129655</td>
<td style="text-align: left;">Ampicillin 100 MG/ML Injectable Solution</td>
<td style="text-align: left;">Drug</td>
<td style="text-align: left;">RxNorm</td>
<td style="text-align: left;">Clinical Drug</td>
<td style="text-align: left;">S</td>
<td style="text-align: left;">789980</td>
<td style="text-align: left;">2008-03-30</td>
<td style="text-align: left;">2099-12-31</td>
<td style="text-align: left;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: right;">44923712</td>
<td style="text-align: left;">celecoxib 200 MG Oral Capsule [Celebrex]</td>
<td style="text-align: left;">Drug</td>
<td style="text-align: left;">NDC</td>
<td style="text-align: left;">11-digit NDC</td>
<td style="text-align: left;">NA</td>
<td style="text-align: left;">00025152531</td>
<td style="text-align: left;">2000-01-01</td>
<td style="text-align: left;">2099-12-31</td>
<td style="text-align: left;">NA</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If a view already exists in your database, then trying to create a new view with the same name will generate an error! To delete a view from memory, using the <code>DROP VIEW</code> command. E.g.:</p>
<pre><code>DROP VIEW IF EXISTS drugs;</code></pre>
</div>
</div>
<section id="check-on-learning-2" class="level4" data-number="3.3.3.1"><h4 data-number="3.3.3.1" class="anchored" data-anchor-id="check-on-learning-2">
<span class="header-section-number">3.3.3.1</span> Check on learning</h4>
<p>Fill in the blank in the query below to create a view that stores only <strong>measurements</strong> from the <code>concept</code> table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CREATE</span> <span class="kw">VIEW</span> measurements <span class="kw">AS</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> concept</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> domain_id <span class="op">==</span> ________;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> measurements</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section></section><section id="query-optimization" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="query-optimization">
<span class="header-section-number">3.4</span> Query Optimization</h2>
<p>While writing efficient SQL queries is important, database performance optimization is a complex topic that is mostly beyond the scope of <em>“Intro to SQL”</em>. However, here are some key takeaways to keep in mind:</p>
<ul>
<li><p><strong>Do not manually create indexes</strong>: Indexing can significantly improve query performance, but in most cases, it is <strong>the responsibility of the Database Administrator (DBA)</strong> to manage indexes appropriately. If you believe an index is needed, consult with your DBA.</p></li>
<li><p><strong>When in doubt, talk to your database administrator</strong>: They have the expertise to optimize database performance, manage indexing, and ensure efficient query execution.</p></li>
</ul></section><section id="summary" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="summary">
<span class="header-section-number">3.5</span> Summary</h2>
<ul>
<li>Subqueries allow us to use the result of one query inside another</li>
<li>Views provide a way to store and reuse complex queries as virtual tables</li>
<li>Using subqueries and views can make SQL queries more modular and maintanable.</li>
</ul></section><section id="always-close-the-connection" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="always-close-the-connection">
<span class="header-section-number">3.6</span> Always close the connection</h2>
<p>When we’re done, always close the connection with <code><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect()</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="references" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="references">
<span class="header-section-number">3.7</span> References</h2>
<ul>
<li>
<a href="https://dataschool.com/how-to-teach-people-sql/how-sql-subqueries-work/">The Data School</a> - all <code>SUBQUERY</code> animations come from here</li>
<li>
<a href="https://www.sqlshack.com/create-view-sql-modifying-views-in-sql-server/">SQL Shack</a> - the image depicting the creation of a <code>VIEW</code> comes from here</li>
<li>
<a href="https://www.w3schools.com/sql/func_sqlserver_datediff.asp">W3 Schools</a> - a reference for parameter options for <code>DATEDIFF</code>
</li>
</ul>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./week1.html" class="pagination-link" aria-label="Week 1">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Week 1</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./miscellaneous.html" class="pagination-link" aria-label="Miscellaneous Grabbag">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Miscellaneous Grabbag</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>This book was built with <a href="https://quarto.org/" style="color: #fff;">Quarto</a> using <a href="https://github.com/fhdsl/OTTR_Quarto" style="color: #fff;">OTTR</a>.</p>
</div>   
    <div class="nav-footer-center">
<p>All illustrations <a href="https://creativecommons.org/licenses/by/4.0/" style="color: #fff;">CC-BY. </a> <br> All other materials <a href="https://creativecommons.org/licenses/by/4.0/" style="color: #fff;"> CC-BY </a> unless noted otherwise.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/fhdsl/intro_to_sql/edit/main/week4.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link active" href="https://github.com/fhdsl/intro_to_sql" aria-current="page">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://fhdata.slack.com/join/signup#/domain-signup">
      <i class="bi bi-slack" role="img">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>